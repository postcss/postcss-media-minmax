import{isFunctionNode as e,isTokenNode as r,gatherNodeAncestry as t}from"@csstools/css-parser-algorithms";import{TokenType as i,NumberType as n,stringify as a}from"@csstools/css-tokenizer";import{invertComparison as o,MediaFeatureEQ as s,MediaFeatureLT as u,MediaFeatureGT as c,newMediaFeaturePlain as l,matchesRatioExactly as d,isMediaFeatureRange as p,isMediaFeature as v,isMediaFeatureRangeNameValue as f,isMediaFeatureRangeValueName as m,isMediaInParens as h,MediaInParens as w,MediaAnd as g,MediaConditionListWithAnd as y,MediaCondition as L,isMediaConditionListWithAnd as W,isMediaAnd as b,isMediaCondition as O,isMediaQuery as Q,parse as T,parseCustomMedia as _}from"@csstools/media-query-list-parser";const x={width:"px",height:"px","device-width":"px","device-height":"px","aspect-ratio":"","device-aspect-ratio":"",color:"","color-index":"",monochrome:"",resolution:"dpi"};function E(e){return e===u.LT||e===u.LT_OR_EQ?"max-":e===c.GT||e===c.GT_OR_EQ?"min-":""}const I={">":1,"<":-1};function A(t,a,p,v){let f,m=p.before,h=p.after;if(v||(m=p.after,h=p.before),!v){const e=o(a);if(!1===e)return;a=e}if(a===s.EQ||a===u.LT_OR_EQ||a===c.GT_OR_EQ)return Array.isArray(p.value)?l(E(a)+t,...m,...p.value.flatMap((e=>e.tokens())),...h):l(E(a)+t,...m,...p.value.tokens(),...h);if(!Array.isArray(p.value)||!d(p.value)){if(f=Array.isArray(p.value)?p.value.find((t=>e(t)||r(t))):p.value,e(f)&&"calc"===f.getName().toLowerCase()){let e;if(x[t.toLowerCase()]){const r=I[a],o=x[t.toLowerCase()];e=[i.Dimension,`${r.toString()}${o}`,-1,-1,{value:r,unit:o,type:n.Integer}]}else{const r=I[a];e=[i.Number,r.toString(),-1,-1,{value:r,type:n.Integer}]}return l(E(a)+t,...m,[i.Function,"calc(",-1,-1,{value:"calc("}],[i.OpenParen,"(",-1,-1,void 0],...f.tokens().slice(1),[i.Whitespace," ",-1,-1,void 0],[i.Delim,"+",-1,-1,void 0],[i.Whitespace," ",-1,-1,void 0],e,[i.CloseParen,")",-1,-1,void 0],...h)}if(r(f)){let e,r=f.value,o=!1;if(r[0]!==i.Dimension&&r[0]!==i.Number||0!==r[4].value)if(r[0]===i.Dimension&&"px"===r[4].unit&&r[4].type===n.Integer)e=r[4].value+I[a];else{if(r[0]!==i.Dimension&&r[0]!==i.Number)return;e=Number(Math.round(Number(r[4].value+.001*I[a]+"e6"))+"e-6")}else e=I[a],o=x[t.toLowerCase()];return!1!==o&&(r=[i.Dimension,r[1],r[2],r[3],{value:r[4].value,unit:o,type:r[4].type}]),r[4].value=e,r[0]===i.Dimension?r[1]=r[4].value.toString()+r[4].unit:r[1]=r[4].value.toString(),l(E(a)+t,...m,r,...h)}}}const C=new Set(["aspect-ratio","color","color-index","device-aspect-ratio","device-height","device-width","height","horizontal-viewport-segments","monochrome","resolution","vertical-viewport-segments","width"]);function D(e){return e.map(((e,r)=>{const n=t(e);e.walk((r=>{const t=r.node;if(!p(t))return;const a=r.parent;if(!v(a))return;const o=t.name.getName();if(!C.has(o.toLowerCase()))return;if(f(t)||m(t)){const e=t.operatorKind();if(!1===e)return;const r=A(o,e,t.value,f(t));return void(r&&(a.feature=r.feature))}const s=n.get(a);if(!h(s))return;let c=null,l=null;{const e=t.valueOneOperatorKind();if(!1===e)return;const r=A(o,e,t.valueOne,!1);if(!r)return;e===u.LT||e===u.LT_OR_EQ?(c=r,c.before=a.before):(l=r,l.after=a.after)}{const e=t.valueTwoOperatorKind();if(!1===e)return;const r=A(o,e,t.valueTwo,!0);if(!r)return;e===u.LT||e===u.LT_OR_EQ?(l=r,l.before=a.before):(c=r,c.after=a.after)}const d=new w(c),T=new w(l),_=function(e,r){let t=e;if(!t)return;if(t=r.get(t),W(t))return t;if(!b(t))return;if(t=r.get(t),W(t))return t;return}(s,n);if(_)return _.leading===s?(_.leading=d,void(_.list=[new g([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],T),..._.list])):void _.list.splice(_.indexOf(n.get(s)),1,new g([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],d),new g([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],T));const x=new y(d,[new g([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],T)],[[i.Whitespace," ",-1,-1,void 0]]),E=function(e,r,t){let i=e;if(!i)return;if(i=t.get(i),!O(i))return;const n=i;if(i=t.get(i),!Q(i))return;if(i!==r)return;return n}(s,e,n);E?E.media=x:s.media=new L(new w(new L(x),[[i.Whitespace," ",-1,-1,void 0],[i.OpenParen,"(",-1,-1,void 0]],[[i.CloseParen,")",-1,-1,void 0]]))}));const o=e.tokens();return a(...o.filter(((e,t)=>(0!==t||0!==r||e[0]!==i.Whitespace)&&(e[0]!==i.Whitespace||!o[t+1]||o[t+1][0]!==i.Whitespace))))})).join(",")}const N=()=>({postcssPlugin:"postcss-media-minmax",AtRule:{media:e=>{if(!(e.params.includes("<")||e.params.includes(">")||e.params.includes("=")))return;const r=D(T(e.params,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw e.error(`Unable to parse media query "${e.params}"`)}}));e.params!==r&&(e.params=r)},"custom-media":e=>{if(!(e.params.includes("<")||e.params.includes(">")||e.params.includes("=")))return;const r=_(e.params,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw e.error(`Unable to parse media query "${e.params}"`)}});if(!r)return;if(!r.hasMediaQueryList())return;const t=r.mediaQueryList.map((e=>e.toString())).join(","),i=D(r.mediaQueryList);t!==i&&(e.params=e.params.replace(t," "+i))}}});N.postcss=!0;export{N as default};
