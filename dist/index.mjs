import{isFunctionNode as e,isTokenNode as t,gatherNodeAncestry as r}from"@csstools/css-parser-algorithms";import{TokenType as i,NumberType as n,stringify as a}from"@csstools/css-tokenizer";import{invertComparison as o,MediaFeatureEQ as s,MediaFeatureLT as u,MediaFeatureGT as c,newMediaFeaturePlain as l,matchesRatioExactly as d,matchesRatio as p,isMediaFeatureRange as v,isMediaFeature as m,isMediaFeatureRangeNameValue as f,isMediaFeatureRangeValueName as h,isMediaInParens as g,MediaInParens as w,MediaAnd as b,MediaConditionListWithAnd as y,MediaCondition as N,isMediaConditionListWithAnd as W,isMediaAnd as x,isMediaCondition as O,isMediaQuery as I,parse as L,parseCustomMedia as Q}from"@csstools/media-query-list-parser";import{calcFromComponentValues as T}from"@csstools/css-calc";const _=/[A-Z]/g;const E={width:"px",height:"px","device-width":"px","device-height":"px","aspect-ratio":"","device-aspect-ratio":"",color:"","color-index":"",monochrome:"",resolution:"dpi"},S={width:!1,height:!1,"device-width":!1,"device-height":!1,"aspect-ratio":!1,"device-aspect-ratio":!1,color:!0,"color-index":!0,monochrome:!0,resolution:"dpi"};function C(e){return e===u.LT||e===u.LT_OR_EQ?"max-":e===c.GT||e===c.GT_OR_EQ?"min-":""}const D={">":1,"<":-1},P=.001,k=.02;function A(r,a,v,m){let f=v.before,h=v.after;if(m||(f=v.after,h=v.before),!m){const e=o(a);if(!1===e)return;a=e}if(a===s.EQ||a===u.LT_OR_EQ||a===c.GT_OR_EQ)return Array.isArray(v.value)?l(C(a)+r,...f,...v.value.flatMap((e=>e.tokens())),...h):l(C(a)+r,...f,...v.value.tokens(),...h);let g,w,b=!1;if(Array.isArray(v.value)){if(!d(v.value))return;if("aspect-ratio"!==r&&"device-aspect-ratio"!==r)return;const e=p(v.value);if(-1===e)return;b=!0,g=v.value[e[0]],w=[...v.value.slice(e[0]+1).flatMap((e=>e.tokens()))]}else g=v.value,w=[];const y=E[r.toLowerCase()];if(e(g)&&"calc"===g.getName().toLowerCase()){const[[e]]=T([[g]],{precision:5,toCanonicalUnits:!0});if(!e||!t(e)||e.value[0]!==i.Number&&e.value[0]!==i.Percentage&&e.value[0]!==i.Dimension||!Number.isInteger(e.value[4].value)){let e;if(void 0!==y){const t=D[a]*("px"===y?k:P);e=[i.Dimension,`${t.toString()}${y}`,-1,-1,{value:t,unit:y,type:n.Integer}]}else if(!0===S[r]){const t=D[a];e=[i.Number,t.toString(),-1,-1,{value:t,type:n.Integer}]}else if(b){const t=D[a]*P;e=[i.Number,t.toString(),-1,-1,{value:t,type:n.Integer}]}else{const t=D[a];e=[i.Number,t.toString(),-1,-1,{value:t,type:n.Integer}]}return l(C(a)+r,...f,[i.Function,"calc(",-1,-1,{value:"calc("}],[i.OpenParen,"(",-1,-1,void 0],...g.tokens().slice(1),[i.Whitespace," ",-1,-1,void 0],[i.Delim,"+",-1,-1,{value:"+"}],[i.Whitespace," ",-1,-1,void 0],e,[i.CloseParen,")",-1,-1,void 0],...w,...h)}g=e}if(!t(g))return;let N,W=g.value,x="";if(void 0!==y&&W[0]===i.Number&&0===W[4].value)N=D[a],x=y;else if(W[0]===i.Number&&0===W[4].value)N=D[a],x="";else if(W[0]===i.Dimension&&0===W[4].value)N=D[a],x=W[4].unit;else if(W[0]===i.Number&&!0===S[r])N=W[4].value+D[a];else if(W[0]===i.Dimension&&"px"===W[4].unit&&W[4].type===n.Integer)N=Number(Math.round(Number(W[4].value+k*D[a]+"e6"))+"e-6");else{if(W[0]!==i.Dimension&&W[0]!==i.Number)return;N=Number(Math.round(Number(W[4].value+P*D[a]+"e6"))+"e-6")}return x&&(W=[i.Dimension,W[1],W[2],W[3],{value:W[4].value,unit:x,type:W[4].type}]),W[4].value=N,W[0]===i.Dimension?W[1]=W[4].value.toString()+W[4].unit:W[1]=W[4].value.toString(),l(C(a)+r,...f,W,...w,...h)}const M=new Set(["aspect-ratio","color","color-index","device-aspect-ratio","device-height","device-width","height","horizontal-viewport-segments","monochrome","resolution","vertical-viewport-segments","width"]);function R(e){return e.map(((e,t)=>{const n=r(e);e.walk((t=>{const r=t.node;if(!v(r))return;const a=t.parent;if(!m(a))return;const o=r.name.getName().replace(_,(e=>String.fromCharCode(e.charCodeAt(0)+32)));if(!M.has(o))return;if(f(r)||h(r)){const e=r.operatorKind();if(!1===e)return;const t=A(o,e,r.value,f(r));return void(t&&(a.feature=t.feature))}const s=n.get(a);if(!g(s))return;let c=null,l=null;{const e=r.valueOneOperatorKind();if(!1===e)return;const t=A(o,e,r.valueOne,!1);if(!t)return;e===u.LT||e===u.LT_OR_EQ?(c=t,c.before=a.before):(l=t,l.after=a.after)}{const e=r.valueTwoOperatorKind();if(!1===e)return;const t=A(o,e,r.valueTwo,!0);if(!t)return;e===u.LT||e===u.LT_OR_EQ?(l=t,l.before=a.before):(c=t,c.after=a.after)}if(!c||!l)return;const d=new w(c),p=new w(l),L=function(e,t){let r=e;if(!r)return;if(r=t.get(r),W(r))return r;if(!x(r))return;if(r=t.get(r),W(r))return r;return}(s,n);if(L)return L.leading===s?(L.leading=d,void(L.list=[new b([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],p),...L.list])):void L.list.splice(L.indexOf(n.get(s)),1,new b([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],d),new b([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],p));const Q=new y(d,[new b([[i.Whitespace," ",-1,-1,void 0],[i.Ident,"and",-1,-1,{value:"and"}],[i.Whitespace," ",-1,-1,void 0]],p)],[[i.Whitespace," ",-1,-1,void 0]]),T=function(e,t,r){let i=e;if(!i)return;if(i=r.get(i),!O(i))return;const n=i;if(i=r.get(i),!I(i))return;if(i!==t)return;return n}(s,e,n);T?T.media=Q:s.media=new N(new w(new N(Q),[[i.Whitespace," ",-1,-1,void 0],[i.OpenParen,"(",-1,-1,void 0]],[[i.CloseParen,")",-1,-1,void 0]]))}));const o=e.tokens();return a(...o.filter(((e,r)=>(0!==r||0!==t||e[0]!==i.Whitespace)&&(e[0]!==i.Whitespace||!o[r+1]||o[r+1][0]!==i.Whitespace))))})).join(",")}const $=()=>({postcssPlugin:"postcss-media-minmax",AtRule:{media:e=>{if(!(e.params.includes("<")||e.params.includes(">")||e.params.includes("=")))return;const t=R(L(e.params,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw e.error(`Unable to parse media query "${e.params}"`)}}));e.params!==t&&(e.params=t)},"custom-media":e=>{if(!(e.params.includes("<")||e.params.includes(">")||e.params.includes("=")))return;const t=Q(e.params,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw e.error(`Unable to parse media query "${e.params}"`)}});if(!t)return;if(!t.hasMediaQueryList())return;const r=t.mediaQueryList.map((e=>e.toString())).join(","),i=R(t.mediaQueryList);r!==i&&(e.params=e.params.replace(r," "+i))}}});$.postcss=!0;export{$ as default};
