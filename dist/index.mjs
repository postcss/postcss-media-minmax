import{isFunctionNode as e,isTokenNode as t,gatherNodeAncestry as n}from"@csstools/css-parser-algorithms";import{TokenType as r,NumberType as i}from"@csstools/css-tokenizer";import{invertComparison as o,MediaFeatureEQ as a,MediaFeatureLT as s,MediaFeatureGT as u,newMediaFeaturePlain as c,matchesRatioExactly as l,parse as d,isMediaFeatureRange as v,isMediaFeature as p,isMediaFeatureRangeNameValue as m,isMediaFeatureRangeValueName as f,isMediaInParens as h,MediaInParens as g,MediaAnd as w,MediaConditionListWithAnd as O,MediaCondition as W,isMediaConditionListWithAnd as x,isMediaAnd as y,isMediaCondition as T,isMediaQuery as I}from"@csstools/media-query-list-parser";const L={width:"px",height:"px","device-width":"px","device-height":"px","aspect-ratio":"","device-aspect-ratio":"",color:"","color-index":"",monochrome:"",resolution:"dpi"};function _(e){return e===s.LT||e===s.LT_OR_EQ?"max-":e===u.GT||e===u.GT_OR_EQ?"min-":""}const b={">":1,"<":-1};function C(n,d,v,p){if(!p){const e=o(d);if(!1===e)return;d=e}if(d===a.EQ||d===s.LT_OR_EQ||d===u.GT_OR_EQ){return c(_(d)+n,...v.tokens())}if(Array.isArray(v.value)&&l(v.value))return;let m;if(m=Array.isArray(v.value)?v.value.find((n=>e(n)||t(n))):v.value,e(m)&&"calc"===m.nameTokenValue().toLowerCase()){let e;if(L[n.toLowerCase()]){const t=b[d],o=L[n.toLowerCase()];e=[r.Dimension,`${t.toString()}${o}`,-1,-1,{value:t,unit:o,type:i.Integer}]}else{const t=b[d];e=[r.Number,t.toString(),-1,-1,{value:t,type:i.Integer}]}return c(_(d)+n,[r.Function,"calc(",-1,-1,{value:"calc("}],[r.OpenParen,"(",-1,-1,void 0],...m.tokens().slice(1),[r.Whitespace," ",-1,-1,void 0],[r.Delim,"+",-1,-1,void 0],[r.Whitespace," ",-1,-1,void 0],e,[r.CloseParen,")",-1,-1,void 0])}if(t(m)){let e,t=m.value,o=!1;if(t[0]!==r.Dimension&&t[0]!==r.Number||0!==t[4].value)if(t[0]===r.Dimension&&"px"===t[4].unit&&t[4].type===i.Integer)e=t[4].value+b[d];else{if(t[0]!==r.Dimension&&t[0]!==r.Number)return;e=Number(Math.round(Number(t[4].value+.001*b[d]+"e6"))+"e-6")}else e=b[d],o=L[n.toLowerCase()];!1!==o&&(t=[r.Dimension,t[1],t[2],t[3],{value:t[4].value,unit:o,type:t[4].type}]),t[4].value=e,t[0]===r.Dimension?t[1]=t[4].value.toString()+t[4].unit:t[1]=t[4].value.toString();return c(_(d)+n,t)}}const D=new Set(["aspect-ratio","color","color-index","device-aspect-ratio","device-height","device-width","height","horizontal-viewport-segments","monochrome","resolution","vertical-viewport-segments","width"]);function E(e){return d(e,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw new Error(`Unable to parse media query "${e}"`)}}).map((e=>{const t=n(e);return e.walk((n=>{const i=n.node;if(!v(i))return;const o=n.parent;if(!p(o))return;const a=i.name.getName();if(!D.has(a.toLowerCase()))return;if(m(i)||f(i)){const e=i.operatorKind();if(!1===e)return;const t=C(a,e,i.value,m(i));return void(t&&(o.feature=t.feature))}const s=t.get(o);if(!h(s))return;let u=null,c=null;{const e=i.valueOneOperatorKind();if(!1===e)return;const t=C(a,e,i.valueOne,!1);if(!t)return;u=t}{const e=i.valueTwoOperatorKind();if(!1===e)return;const t=C(a,e,i.valueTwo,!0);if(!t)return;c=t}const l=new g(u),d=new g(c),L=function(e,t){let n=e;if(!n)return;if(n=t.get(n),x(n))return n;if(n=t.get(n),!y(n))return;if(n=t.get(n),x(n))return n;return}(s,t);if(L)return L.leading===s?(L.leading=l,void(L.list=[new w([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],d),...L.list])):void L.list.splice(L.indexOf(t.get(s)),1,new w([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],l),new w([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],d));const _=new O(l,[new w([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],d)],[[r.Whitespace," ",-1,-1,void 0]]),b=function(e,t,n){let r=e;if(!r)return;if(r=n.get(r),!T(r))return;const i=r;if(r=n.get(r),!I(r))return;if(r!==t)return;return i}(s,e,t);b?b.media=_:s.media=new W(new g(new W(_),[[r.Whitespace," ",-1,-1,void 0],[r.OpenParen,"(",-1,-1,void 0]],[[r.CloseParen,")",-1,-1,void 0]]))})),e.toString()})).join(",")}const N=e=>{const t=Object.assign({preserve:!1},e);return{postcssPlugin:"postcss-media-minmax",AtRule:{media:e=>{if(!(e.params.includes("<")||e.params.includes(">")||e.params.includes("=")))return;const n=E(e.params);e.params!==n&&(e.cloneBefore({params:n}),t.preserve||e.remove())}}}};N.postcss=!0;export{N as default};
